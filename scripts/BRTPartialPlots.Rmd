---
title: "Partial Plots"
author: "Anna Talucci"
date: "September 20, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Overview
# September 2019: Extra fun with partial plots.  This script is designed to use brt model runs saved as .Rdas.
# Goal: Overlay partial-dependence plots from multiple models.

NOte: the y-axis of the BRT model are referred to as the fitted function, for a binomial distribtuion this fitted function is the loggit scale. To convert back to a probability we can use the plogis() function. We will leave the y-axix on the logit scale but also add a line for a high probability

setwd("K:/Papers/Meigs_Refugia2_LateSuccessionalForests/r_files_brt")   ### Change to wherever you put the code files sourced below

# Load packages
```{r message=FALSE, warning=FALSE}
library(gbm)
library(dismo)
library(purrr) # for looping
library(ggplot2)
library(scales)
library(dplyr) # for data manip
library(cowplot)
```

# BRT Models

Model         | FWI        | Variables
------------- | ---------- | -------------------------------------------
brt.model1    | FWI HI     | Prefire, outbreak, weather, topography
brt.model2    | FWI MOD    | Prefire, outbreak, weather, topography
brt.model3    | FWI HI     | Prefire, weather, topography
brt.model4    | FWI MOD    | Prefire, weather, topography
brt.model5    | Full FWI   | Prefire, weather, topography
brt.model6    | Full FWI   | Prefire, outbreak, weather, topography
brt.model7    | FWI HI     | Outbreak, weather, topography
brt.model8    | FWI Mod    | Outbreak, weather, topography
brt.model9    | Full FWI   | Outbreak, weather, topography




# Load BRT Models 
Load BRT models that are saved during the model as .Rda files in the working directory. Models are assembled and run in the script 'BRTAnalyses'
```{r}
load(file = "../output/finalmodels/BRTF1_model_data_output.rda")
brt.model1 = brt.modelF1

load(file = "../output/finalmodels/BRTF2_model_data_output.rda")
brt.model2 = brt.modelF2

load(file = "../output/finalmodels/BRTF6_model_data_output.rda")
brt.model6 = brt.modelF6

load(file = "../output/finalmodels/BRTF3_model_data_output.rda")
brt.model3 = brt.modelF3

load(file = "../output/finalmodels/BRTF4_model_data_output.rda")
brt.model4 = brt.modelF4

load(file = "../output/finalmodels/BRTF5_model_data_output.rda")
brt.model5 = brt.modelF5

load(file = "../output/finalmodels/BRTF7_model_data_output.rda")
brt.model7 = brt.modelF7

load(file = "../output/finalmodels/BRTF8_model_data_output.rda")
brt.model8 = brt.modelF8

load(file = "../output/finalmodels/BRTF9_model_data_output.rda")
brt.model9 = brt.modelF9
```




# Manuscript figure

## Four Variable Model

### Make list of models and variables
Hi_3var = brt.model3, Mod_3var = brt.model4, Full_3var = brt.model5,
```{r}
mods4 = list(Hi_4var = brt.model1, Mod_4var = brt.model2, Full_4var = brt.model6)
vars4 = c("dndmi", "elevation", "fwi", "ndviprefire")
names(vars4) = vars4
vars4
```

Nicer variable names for x axis labels Must be in same order as vars
```{r}
x_names4 = c("Outbreak severity (dNDMI)", "Elevation (m)", "Fire weather index", "Prefire vegetation (NDVI)")
```

## Predicted dataset 
Use nested loops for each variable and then each model within each variable

 For outer loop use map() or lapply()
 For the inner loop use imap_dfr() to use models and model names and bind together

 Work out approach with a single variable
 Goal is to get a dataset with predictions from all models stacked together for one x variable
### Loop throughy single varible
```{r}
pred_test4 = map(vars4[[1]], function(variable) {
     imap_dfr(mods4, function(Model, mod.name) {
          preddat = plot.gbm(Model, i.var = variable, return.grid = TRUE)
          preddat$center_y = scale(preddat$y, scale = FALSE)
          preddat$x = preddat[, 1]
          preddat$Model = mod.name
          preddat
     })
})

pred_test4
```

### Loop through all Varaibles 
If that worked, loop through all variables
```{r}
pred_mods4 = map(vars4, function(variable) {
     imap_dfr(mods4, function(model, mod.name) {
          preddat = plot.gbm(model, i.var = variable, return.grid = TRUE)
          preddat$center_y = scale(preddat$y, scale = FALSE)
          preddat$x = preddat[, 1]
          preddat$model = mod.name
          preddat
     })
})
```

## Figure out plot limits (if want all the same) by binding all groups together and calculating min and max center_y
```{r}
range(bind_rows(pred_mods4)$center_y)
```

# Plot with improved x axis names ----
```{r}
model_id <- ggplot(data = pred_mods4[[1]], aes(x = x, y = center_y, linetype = model, color = model) ) +
        geom_smooth(span = 0.5, se = FALSE) + # choose span? 
        scale_color_manual(values = c("blue","red", "orange"), name = "Fire weather", guide = guide_legend(reverse=TRUE)) +
        scale_linetype_manual(values = c("solid", "longdash", "twodash"), name = "Fire weather", guide = guide_legend(reverse=TRUE)) +
        labs(y = "Fitted Function",
             x = x_names4[[1]]) +
        theme_bw(base_size = 12) +
        theme(axis.text.x = element_text(size = 10, color = "black"),
              axis.text.y = element_text(size = 10, color = "black"),
              panel.border = element_rect(color = "black", size = 1.25),
              panel.grid.major = element_line(color = 'white', linetype = 'dashed'), panel.grid.minor = element_blank(),
              legend.position = "bottom",
              legend.title = element_text(size = 14),
              legend.text = element_text(size = 14)) +
        scale_x_continuous(labels = scales::format_format(scientific = FALSE)) +
        #scale_x_continuous(labels = comma) +
        #ylim(-1.55, 1.55) +
        geom_hline(yintercept=0)+
        scale_y_continuous(limits=c(-1.5,1.5), breaks=c(-1.5,-1,-0.75,0,0.5,1,1.5))
model_id
```
Leaving legend to indicate multiple models plotted.

## Legend Manuscript
Assemble ledgend for final figure
```{r}
legend.manuscript <- ggplot(data = pred_mods4[[1]], aes(x = x, y = center_y, linetype = model, color = model) ) +
        geom_smooth(span = 0.5, se = FALSE) + # choose span? 
        scale_color_manual(values = c("blue","red", "orange"), name = "Burning conditions model", labels=c("Full", "Extreme", "Moderate"), guide = guide_legend(reverse=TRUE)) +
        scale_linetype_manual(values = c("solid", "longdash", "dotdash"), name = "Burning conditions model", labels=c("Full", "Extreme", "Moderate"), guide = guide_legend(reverse=TRUE), guides(linetype = guide_legend(override.aes = list(size = 2)))) +
        labs(y = "Fitted Function",
             x = x_names4[[1]]) +
        theme_bw(base_size = 14) +
        theme(axis.text.x = element_text(size = 11, color = "black"),
              axis.text.y = element_text(size = 11, color = "black"),
              panel.border = element_rect(color = "black", size = 1.25),
              panel.grid.major = element_line(color = 'white', linetype = 'dashed'), panel.grid.minor = element_blank(),
              legend.position = "right",
              legend.title = element_text(size = 11, color = "black"),
              legend.text = element_text(size = 11, color = "black")) +
        
        scale_x_continuous(labels = scales::format_format(scientific = FALSE)) +
        #scale_x_continuous(labels = comma) +
        #ylim(-1.55, 1.55) +
        geom_hline(yintercept=0)
legend.manuscript
```


### Plotting function ----
Note: plot.margin - t,r,b,l

Adjust plot margins for compiling a panel figure with cowplot.

```{r}
pardep_plot_mods4 = function(data, x_var) {
     ggplot(data = data, aes(x = x, y = center_y, linetype = model, color = model) ) +
                geom_smooth(span = 0.5, se = FALSE) + # choose span? 
                scale_color_manual(values = c("blue","red", "orange")) +
                labs(y = "Fitted function",
                     x = x_var) +
                theme_bw(base_size = 12) +
                theme(plot.margin = unit(c(0.05, 0.2, 0.05, 0.5), "cm")) +
                theme(axis.text.x = element_text(size = 10, color = "black"),
                      axis.text.y = element_text(size = 10, color = "black"),
                      panel.border = element_rect(color = "black", size = 1.25),
                      panel.grid.major = element_line(color = 'white', linetype = 'dashed'), panel.grid.minor = element_blank(),
                      legend.position = "none") +
                scale_x_continuous(labels = scales::format_format(scientific = FALSE)) +
                #scale_x_continuous(labels = comma) +
                #ylim(-1.55, 1.55) +
                geom_hline(yintercept=0)+
                scale_y_continuous(limits=c(-2,2), breaks=c(-2,-1,0,1,2))
}

pardep_plot_mods4(data = pred_mods4[[1]], x_var = x_names4[[1]])
```

# Loop through the models and the x variable names
    simultaneously with map2()
```{r}
all_mod_plots4 = map2(pred_mods4, x_names4, pardep_plot_mods4)
all_mod_plots4
```



# Three Variable Model w/ Prefire
## Make list of models and variables
Hi_3var = brt.model3, Mod_3var = brt.model4, Full_3var = brt.model5,
```{r}
mods3 = list(Hi_3var = brt.model3, Mod_3var = brt.model4, Full_3var = brt.model5)
vars3 = c("elevation", "fwi", "ndviprefire")
names(vars3) = vars3
vars3
```

Nicer variable names for x axis labels Must be in same order as vars
```{r}
x_names3 = c("Elevation (m)", "Fire weather index", "Prefire vegetation (NDVI)")
```


## Use nested loops for each variable and then each model within each variable

 For outer loop use map() or lapply()
 For the inner loop use imap_dfr() to use models and model names and bind together

 Work out approach with a single variable
 Goal is to get a dataset with predictions from all models stacked together for one x variable

```{r}
pred_test3 = map(vars3[[1]], function(variable) {
     imap_dfr(mods3, function(Model, mod.name) {
          preddat = plot.gbm(Model, i.var = variable, return.grid = TRUE)
          preddat$center_y = scale(preddat$y, scale = FALSE)
          preddat$x = preddat[, 1]
          preddat$Model = mod.name
          preddat
     })
})

pred_test3
```



## If that worked, loop through all variables
```{r}
pred_mods3 = map(vars3, function(variable) {
     imap_dfr(mods3, function(model, mod.name) {
          preddat = plot.gbm(model, i.var = variable, return.grid = TRUE)
          preddat$center_y = scale(preddat$y, scale = FALSE)
          preddat$x = preddat[, 1]
          preddat$model = mod.name
          preddat
     })
})
```

## Figure out plot limits (if want all the same) by binding all groups together and calculating min and max center_y
```{r}
range(bind_rows(pred_mods3)$center_y)
```

# Plot with improved x axis names ----
```{r}
model_id <- ggplot(data = pred_mods3[[1]], aes(x = x, y = center_y, linetype = model, color = model) ) +
        geom_smooth(span = 0.5, se = FALSE) + # choose span? 
        scale_color_manual(values = c("blue","red", "orange"), name = "Fire weather", guide = guide_legend(reverse=TRUE)) +
        scale_linetype_manual(values = c("solid", "longdash", "twodash"), name = "Fire weather", guide = guide_legend(reverse=TRUE)) +
        labs(y = "Fitted Function",
             x = x_names3[[1]]) +
        theme_bw(base_size = 14) +
        theme(axis.text.x = element_text(size = 14, color = "black"),
              axis.text.y = element_text(size = 14, color = "black"),
              panel.border = element_rect(color = "black", size = 1.25),
              panel.grid.major = element_line(color = 'white', linetype = 'dashed'), panel.grid.minor = element_blank(),
              legend.position = "bottom",
              legend.title = element_text(size = 14),
              legend.text = element_text(size = 14)) +
        scale_x_continuous(labels = scales::format_format(scientific = FALSE)) +
        #scale_x_continuous(labels = comma) +
        #ylim(-1.55, 1.55) +
        geom_hline(yintercept=0)+
        scale_y_continuous(limits=c(-1.5,1.5), breaks=c(-1.5,-1,-0.5,0,0.5,1,1.5))
model_id
```
Leaving legend to indicate multiple models plotted.

### Plotting function ----
note plot.margin - t,r,b,l
```{r}
pardep_plot_mods3 = function(data, x_var) {
     ggplot(data = data, aes(x = x, y = center_y, linetype = model, color = model) ) +
                geom_smooth(span = 0.5, se = FALSE) + # choose span? 
                scale_color_manual(values = c("blue","red", "orange")) +
                labs(y = "Fitted function",
                     x = x_var) +
                theme_bw(base_size = 12) +
                theme(plot.margin = unit(c(0.05, 0.2, 0.05, 0.5), "cm")) +
                theme(axis.text.x = element_text(size = 10, color = "black"),
                      axis.text.y = element_text(size = 10, color = "black"),
                      panel.border = element_rect(color = "black", size = 1.25),
                      panel.grid.major = element_line(color = 'white', linetype = 'dashed'), panel.grid.minor = element_blank(),
                      legend.position = "none") +
                scale_x_continuous(labels = scales::format_format(scientific = FALSE)) +
                #scale_x_continuous(labels = comma) +
                #ylim(-1.55, 1.55) +
                geom_hline(yintercept=0)+
                scale_y_continuous(limits=c(-2.0,2.0), breaks=c(-2,-1,0,1,2))
}

pardep_plot_mods3(data = pred_mods3[[1]], x_var = x_names3[[1]])
```


## Loop through the models and the x variable names
    simultaneously with map2()
```{r}
all_mod_plots3 = map2(pred_mods3, x_names3, pardep_plot_mods3)
all_mod_plots3
```


# Three Variable Model - Outbreak Severity, Elelvatio, Fire Weather
## Make list of models and variables
Hi_3var = brt.model7, Mod_3var = brt.model8, Full_3var = brt.model9,
```{r}
mods3o = list(Hi_ovar = brt.model7, Mod_ovar = brt.model8, Full_ovar = brt.model9)
ovars = c("elevation", "fwi", "dndmi")
names(ovars) = ovars
ovars
```

Nicer variable names for x axis labels Must be in same order as vars
```{r}
x_names3 = c("Elevation (m)", "Fire weather index", "Outbreak Severity (NDMI)")
```


## Use nested loops for each variable and then each model within each variable

 For outer loop use map() or lapply()
 For the inner loop use imap_dfr() to use models and model names and bind together

 Work out approach with a single variable
 Goal is to get a dataset with predictions from all models stacked together for one x variable

```{r}
pred_test3o = map(ovars[[1]], function(variable) {
     imap_dfr(mods3o, function(Model, mod.name) {
          preddat = plot.gbm(Model, i.var = variable, return.grid = TRUE)
          preddat$center_y = scale(preddat$y, scale = FALSE)
          preddat$x = preddat[, 1]
          preddat$Model = mod.name
          preddat
     })
})

pred_test3o
```


## If that worked, loop through all variables
```{r}
pred_mods3o = map(ovars, function(variable) {
     imap_dfr(mods3o, function(model, mod.name) {
          preddat = plot.gbm(model, i.var = variable, return.grid = TRUE)
          preddat$center_y = scale(preddat$y, scale = FALSE)
          preddat$x = preddat[, 1]
          preddat$model = mod.name
          preddat
     })
})
```

## Figure out plot limits (if want all the same) by binding all groups together and calculating min and max center_y
```{r}
range(bind_rows(pred_mods3o)$center_y)
```

# Plot with improved x axis names ----
```{r}
model_id <- ggplot(data = pred_mods3o[[1]], aes(x = x, y = center_y, linetype = model, color = model) ) +
        geom_smooth(span = 0.5, se = FALSE) + # choose span? 
        scale_color_manual(values = c("blue","red", "orange"), name = "Fire weather", guide = guide_legend(reverse=TRUE)) +
        scale_linetype_manual(values = c("solid", "longdash", "twodash"), name = "Fire weather", guide = guide_legend(reverse=TRUE)) +
        labs(y = "Fitted Function",
             x = x_names3[[1]]) +
        theme_bw(base_size = 14) +
        theme(axis.text.x = element_text(size = 14, color = "black"),
              axis.text.y = element_text(size = 14, color = "black"),
              panel.border = element_rect(color = "black", size = 1.25),
              panel.grid.major = element_line(color = 'white', linetype = 'dashed'), panel.grid.minor = element_blank(),
              legend.position = "bottom",
              legend.title = element_text(size = 14),
              legend.text = element_text(size = 14)) +
        scale_x_continuous(labels = scales::format_format(scientific = FALSE)) +
        #scale_x_continuous(labels = comma) +
        #ylim(-1.55, 1.55) +
        geom_hline(yintercept=0)+
        scale_y_continuous(limits=c(-1.5,1.5), breaks=c(-1.5,-1,-0.5,0,0.5,1,1.5))
model_id
```
Leaving legend to indicate multiple models plotted.

### Plotting function ----
note plot.margin - t,r,b,l
```{r}
pardep_plot_mods3o = function(data, x_var) {
     ggplot(data = data, aes(x = x, y = center_y, linetype = model, color = model) ) +
                geom_smooth(span = 0.5, se = FALSE) + # choose span? 
                scale_color_manual(values = c("blue","red", "orange")) +
                labs(y = "Fitted function",
                     x = x_var) +
                theme_bw(base_size = 12) +
                theme(plot.margin = unit(c(0.05, 0.2, 0.05, 0.5), "cm")) +
                theme(axis.text.x = element_text(size = 10, color = "black"),
                      axis.text.y = element_text(size = 10, color = "black"),
                      panel.border = element_rect(color = "black", size = 1.25),
                      panel.grid.major = element_line(color = 'white', linetype = 'dashed'), panel.grid.minor = element_blank(),
                      legend.position = "none") +
                scale_x_continuous(labels = scales::format_format(scientific = FALSE)) +
                #scale_x_continuous(labels = comma) +
                #ylim(-1.55, 1.55) +
                geom_hline(yintercept=0)+
                scale_y_continuous(limits=c(-2.0,2.0), breaks=c(-2,-1,0,1,2))
}

pardep_plot_mods3o(data = pred_mods3o[[1]], x_var = x_names3[[1]])
```




## Loop through the models and the x variable names
    simultaneously with map2()
```{r}
all_mod_plots3o = map2(pred_mods3o, x_names3, pardep_plot_mods3o)
all_mod_plots3o
```


### Full figure with 7 plots and legend

#### Headers and Legend

```{r}
col1 = ggdraw() + draw_label('Four-variable models', size = 12, fontface = 'bold') 
col2 = ggdraw() + draw_label('Three-variable models', size = 12, fontface = 'bold') 
header = cowplot::plot_grid(col1, col2, ncol=2)
header
```


```{r}
ocol1 = ggdraw() + draw_label('Outbreak severity included', size = 12, fontface = 'bold', hjust=0.35) 
ocol2 = ggdraw() + draw_label('Outbreak severity excluded', size = 12, fontface = 'bold', hjust=0.35) 

oheader2 = cowplot::plot_grid(ocol1, ocol2, ncol=2)
oheader2
```

```{r}
legendman <- get_legend(legend.manuscript) 
```

### Full Figure

```{r fig.height=7, fig.width=6}
grid_all2 = cowplot::plot_grid(all_mod_plots4$ndviprefire, all_mod_plots3$ndviprefire, all_mod_plots4$fwi, all_mod_plots3$fwi, all_mod_plots4$elevation, all_mod_plots3$elevation, all_mod_plots4$dndmi, legendman, ncol = 2) + 
   draw_label("sparse/dead", x = .21, y = .835, size = 10) +
   draw_label("dense/live", x = .41, y = .835, size = 10) +
   draw_label("sparse/dead", x = .7, y = .835, size = 10) +
   draw_label("dense/live", x = .9, y = .835, size = 10) +
   draw_label("moderate", x = .25, y = .59, size = 10) +
   draw_label("extreme", x = .40, y = .59, size = 10) +
   draw_label("moderate", x = .75, y = .59, size = 10) +
   draw_label("extreme", x = .89, y = .59, size = 10) +
   draw_label("low", x = .14, y = .34, size = 10) +
   draw_label("high", x = .44, y = .34, size = 10) +
   draw_label("low", x = .64, y = .34, size = 10) +
   draw_label("high", x = .94, y = .34, size = 10) +
   draw_label("no\nmortality", x = .21, y = .1, size = 10) +
   draw_label("high\nmortality", x = .38, y = .1, size = 10) +
   draw_label("(a)", x = .13, y = .98, size = 10) +
   draw_label("(b)", x = .63, y = .98, size = 10) +
   draw_label("(c)", x = .13, y = .73, size = 10) +
   draw_label("(d)", x = .63, y = .73, size = 10) +
   draw_label("(e)", x = .13, y = .48, size = 10) +
   draw_label("(f)", x = .63, y = .48, size = 10) +
   draw_label("(g)", x = .13, y = .23, size = 10)
grid_all2
```

### Full figure with legend on Right
```{r fig.height=7, fig.width=6}
( grid_final2 = cowplot::plot_grid(oheader2, grid_all2, ncol=1, rel_heights = c(0.04, 1))  )
```

```{r eval=FALSE, include=FALSE}
ggsave("../figures/2020-01-04_partialplots_legendright-outbreak.tiff", plot = grid_final2 , width = 6, height = 7, units = c("in"), dpi=600 )
```


# Poster figure

## Four Variable Model

### Make list of models and variables
Hi_3var = brt.model3, Mod_3var = brt.model4, Full_3var = brt.model5,
```{r}
mods4 = list(Hi_4var = brt.model1, Mod_4var = brt.model2, Full_4var = brt.model6)
vars4 = c("dndmi", "elevation", "fwi", "ndviprefire")
names(vars4) = vars4
vars4
```

Nicer variable names for x axis labels Must be in same order as vars
```{r}
x_names4 = c("Outbreak severity (dNDMI)", "Elevation (m)", "Fire weather index", "Prefire vegetation (NDVI)")
```

## Predicted dataset 
Use nested loops for each variable and then each model within each variable

 For outer loop use map() or lapply()
 For the inner loop use imap_dfr() to use models and model names and bind together

 Work out approach with a single variable
 Goal is to get a dataset with predictions from all models stacked together for one x variable
### Loop throughy single varible
```{r}
pred_test4 = map(vars4[[1]], function(variable) {
     imap_dfr(mods4, function(Model, mod.name) {
          preddat = plot.gbm(Model, i.var = variable, return.grid = TRUE)
          preddat$center_y = scale(preddat$y, scale = FALSE)
          preddat$x = preddat[, 1]
          preddat$Model = mod.name
          preddat
     })
})

pred_test4
```



### Loop through all Varaibles 
If that worked, loop through all variables
```{r}
pred_mods4 = map(vars4, function(variable) {
     imap_dfr(mods4, function(model, mod.name) {
          preddat = plot.gbm(model, i.var = variable, return.grid = TRUE)
          preddat$center_y = scale(preddat$y, scale = FALSE)
          preddat$x = preddat[, 1]
          preddat$model = mod.name
          preddat
     })
})
```

## Figure out plot limits (if want all the same) by binding all groups together and calculating min and max center_y
```{r}
range(bind_rows(pred_mods4)$center_y)
```

# Plot with improved x axis names ----
```{r}
model_id <- ggplot(data = pred_mods4[[1]], aes(x = x, y = center_y, linetype = model, color = model) ) +
        geom_smooth(span = 0.5, se = FALSE) + # choose span? 
        scale_color_manual(values = c("blue","red", "orange"), name = "Fire weather", guide = guide_legend(reverse=TRUE)) +
        scale_linetype_manual(values = c("solid", "longdash", "twodash"), name = "Fire weather", guide = guide_legend(reverse=TRUE)) +
        labs(y = "Fitted Function",
             x = x_names4[[1]]) +
        theme_bw(base_size = 14) +
        theme(axis.text.x = element_text(size = 14, color = "black"),
              axis.text.y = element_text(size = 14, color = "black"),
              panel.border = element_rect(color = "black", size = 1.25),
              panel.grid.major = element_line(color = 'white', linetype = 'dashed'), panel.grid.minor = element_blank(),
              legend.position = "bottom",
              legend.title = element_text(size = 14),
              legend.text = element_text(size = 14)) +
        scale_x_continuous(labels = scales::format_format(scientific = FALSE)) +
        #scale_x_continuous(labels = comma) +
        #ylim(-1.55, 1.55) +
        geom_hline(yintercept=0)+
        scale_y_continuous(limits=c(-1.5,1.5), breaks=c(-1.5,-1,-0.75,0,0.5,1,1.5))
model_id
```
Leaving legend to indicate multiple models plotted.
Remove legend in subsequent step but save this one for cowplot merger below.
## Legend Manuscript
```{r}
legend.manuscript <- ggplot(data = pred_mods4[[1]], aes(x = x, y = center_y, linetype = model, color = model) ) +
        geom_smooth(span = 0.5, se = FALSE) + # choose span? 
        scale_color_manual(values = c("blue","red", "orange"), name = "Burning conditions model", labels=c("Full", "Extreme", "Moderate"), guide = guide_legend(reverse=TRUE)) +
        scale_linetype_manual(values = c("solid", "longdash", "dotdash"), name = "Burning conditions model", labels=c("Full", "Extreme", "Moderate"), guide = guide_legend(reverse=TRUE), guides(linetype = guide_legend(override.aes = list(size = 2)))) +
        labs(y = "Fitted Function",
             x = x_names4[[1]]) +
        theme_bw(base_size = 14) +
        theme(axis.text.x = element_text(size = 11, color = "black"),
              axis.text.y = element_text(size = 11, color = "black"),
              panel.border = element_rect(color = "black", size = 1.25),
              panel.grid.major = element_line(color = 'white', linetype = 'dashed'), panel.grid.minor = element_blank(),
              legend.position = "right",
              legend.title = element_text(size = 11, color = "black"),
              legend.text = element_text(size = 11, color = "black")) +
        
        scale_x_continuous(labels = scales::format_format(scientific = FALSE)) +
        #scale_x_continuous(labels = comma) +
        #ylim(-1.55, 1.55) +
        geom_hline(yintercept=0)
legend.manuscript
```

## Legend Poster
```{r}
legend.poster <- ggplot(data = pred_mods4[[1]], aes(x = x, y = center_y, linetype = model, color = model) ) +
        geom_smooth(span = 0.5, se = FALSE) + # choose span? 
        scale_color_manual(values = c("blue","red", "orange"), name = "Burning conditions model", labels=c("Full", "Extreme", "Moderate"), guide = guide_legend(reverse=TRUE)) +
        scale_linetype_manual(values = c("solid", "longdash", "dotdash"), name = "Burning conditions model", labels=c("Full", "Extreme", "Moderate"), guide = guide_legend(reverse=TRUE), guides(linetype = guide_legend(override.aes = list(size = 2)))) +
        labs(y = "Fitted Function",
             x = x_names4[[1]]) +
        theme_bw(base_size = 14) +
        theme(axis.text.x = element_text(size = 14, color = "black"),
              axis.text.y = element_text(size = 14, color = "black"),
              panel.border = element_rect(color = "black", size = 1.25),
              panel.grid.major = element_line(color = 'white', linetype = 'dashed'), panel.grid.minor = element_blank(),
              legend.position = "right",
              legend.title = element_text(size = 24, color = "black"),
              legend.text = element_text(size = 20, color = "black")) +
        
        scale_x_continuous(labels = scales::format_format(scientific = FALSE)) +
        #scale_x_continuous(labels = comma) +
        #ylim(-1.55, 1.55) +
        geom_hline(yintercept=0)
legend.poster
```




### Plotting function ----
note plot.margin - t,r,b,l
```{r}
pardep_plot_mods4 = function(data, x_var) {
     ggplot(data = data, aes(x = x, y = center_y, linetype = model, color = model) ) +
                geom_smooth(span = 0.5, se = FALSE) + # choose span? 
                scale_color_manual(values = c("blue","red", "orange")) +
                labs(y = "Fitted function",
                     x = x_var) +
                theme_bw(base_size = 12) +
                theme(plot.margin = unit(c(0.05, 0.2, 0.05, 0.5), "cm")) +
                theme(axis.text.x = element_text(size = 12, color = "black"),
                      axis.text.y = element_text(size = 12, color = "black"),
                      axis.title.x = element_text(size=16),
                      axis.title.y = element_text(size=16),
                      panel.border = element_rect(color = "black", size = 1.25),
                      panel.grid.major = element_line(color = 'white', linetype = 'dashed'), panel.grid.minor = element_blank(),
                      legend.position = "none") +
                scale_x_continuous(labels = scales::format_format(scientific = FALSE)) +
                #scale_x_continuous(labels = comma) +
                #ylim(-1.55, 1.55) +
                geom_hline(yintercept=0)+
                scale_y_continuous(limits=c(-2,2), breaks=c(-2,-1,0,1,2))
}

pardep_plot_mods4(data = pred_mods4[[1]], x_var = x_names4[[1]])
```




# Loop through the models and the x variable names
    simultaneously with map2()
```{r}
all_mod_plots4 = map2(pred_mods4, x_names4, pardep_plot_mods4)
all_mod_plots4
```



```{r}
grid1 = cowplot::plot_grid(all_mod_plots4$ndviprefire, all_mod_plots4$fwi, all_mod_plots4$elevation, all_mod_plots4$dndmi, labels = c("a", "b", "C", "d"), ncol = 2)

grid1
```
```{r fig.height=5, fig.width=6}
cowplot::plot_grid(grid1, legend, ncol=1, rel_widths = c(1, .1), rel_heights = c(1, .05))  
```



# Three Variable Model
## Make list of models and variables
Hi_3var = brt.model3, Mod_3var = brt.model4, Full_3var = brt.model5,
```{r}
mods3 = list(Hi_3var = brt.model3, Mod_3var = brt.model4, Full_3var = brt.model5)
vars3 = c("elevation", "fwi", "ndviprefire")
names(vars3) = vars3
vars3
```

Nicer variable names for x axis labels Must be in same order as vars
```{r}
x_names3 = c("Elevation (m)", "Fire weather index", "Prefire vegetation (NDVI)")
```


## Use nested loops for each variable and then each model within each variable

 For outer loop use map() or lapply()
 For the inner loop use imap_dfr() to use models and model names and bind together

 Work out approach with a single variable
 Goal is to get a dataset with predictions from all models stacked together for one x variable

```{r}
pred_test3 = map(vars3[[1]], function(variable) {
     imap_dfr(mods3, function(Model, mod.name) {
          preddat = plot.gbm(Model, i.var = variable, return.grid = TRUE)
          preddat$center_y = scale(preddat$y, scale = FALSE)
          preddat$x = preddat[, 1]
          preddat$Model = mod.name
          preddat
     })
})

pred_test3
```



## If that worked, loop through all variables
```{r}
pred_mods3 = map(vars3, function(variable) {
     imap_dfr(mods3, function(model, mod.name) {
          preddat = plot.gbm(model, i.var = variable, return.grid = TRUE)
          preddat$center_y = scale(preddat$y, scale = FALSE)
          preddat$x = preddat[, 1]
          preddat$model = mod.name
          preddat
     })
})
```

## Figure out plot limits (if want all the same) by binding all groups together and calculating min and max center_y
```{r}
range(bind_rows(pred_mods3)$center_y)
```

# Plot with improved x axis names ----
```{r}
model_id <- ggplot(data = pred_mods3[[1]], aes(x = x, y = center_y, linetype = model, color = model) ) +
        geom_smooth(span = 0.5, se = FALSE) + # choose span? 
        scale_color_manual(values = c("blue","red", "orange"), name = "Fire weather", guide = guide_legend(reverse=TRUE)) +
        scale_linetype_manual(values = c("solid", "longdash", "twodash"), name = "Fire weather", guide = guide_legend(reverse=TRUE)) +
        labs(y = "Fitted Function",
             x = x_names3[[1]]) +
        theme_bw(base_size = 14) +
        theme(axis.text.x = element_text(size = 14, color = "black"),
              axis.text.y = element_text(size = 14, color = "black"),
              panel.border = element_rect(color = "black", size = 1.25),
              panel.grid.major = element_line(color = 'white', linetype = 'dashed'), panel.grid.minor = element_blank(),
              legend.position = "bottom",
              legend.title = element_text(size = 14),
              legend.text = element_text(size = 14)) +
        scale_x_continuous(labels = scales::format_format(scientific = FALSE)) +
        #scale_x_continuous(labels = comma) +
        #ylim(-1.55, 1.55) +
        geom_hline(yintercept=0)+
        scale_y_continuous(limits=c(-1.5,1.5), breaks=c(-1.5,-1,-0.5,0,0.5,1,1.5))
model_id
```
Leaving legend to indicate multiple models plotted.
Remove legend in subsequent step but save this one for cowplot merger below.
```{r}
legend.plot3 <- ggplot(data = pred_mods3[[1]], aes(x = x, y = center_y, linetype = model, color = model) ) +
        geom_smooth(span = 0.5, se = FALSE) + # choose span? 
        scale_color_manual(values = c("blue","red", "orange"), name = "Fire weather", labels=c("Full", "High", "Moderate"), guide = guide_legend(reverse=TRUE)) +
        scale_linetype_manual(values = c("solid", "longdash", "dotdash"), name = "Fire weather", labels=c("Full", "High", "Moderate"), guide = guide_legend(reverse=TRUE), guides(linetype = guide_legend(override.aes = list(size = 2)))) +
        labs(y = "Fitted Function",
             x = x_names3[[1]]) +
        theme_bw(base_size = 14) +
        theme(axis.text.x = element_text(size = 14, color = "black"),
              axis.text.y = element_text(size = 14, color = "black"),
              panel.border = element_rect(color = "black", size = 1.25),
              panel.grid.major = element_line(color = 'white', linetype = 'dashed'), panel.grid.minor = element_blank(),
              legend.position = "bottom",
              legend.title = element_text(size = 14),
              legend.text = element_text(size = 14)) +
        
        scale_x_continuous(labels = scales::format_format(scientific = FALSE)) +
        #scale_x_continuous(labels = comma) +
        #ylim(-1.55, 1.55) +
        geom_hline(yintercept=0)+
        scale_y_continuous(limits=c(-1.5,1.5), breaks=c(-1.5,-1,-0.5,0,0.5,1,1.5))
legend.plot3
```




### Plotting function ----
note plot.margin - t,r,b,l
```{r}
pardep_plot_mods3 = function(data, x_var) {
     ggplot(data = data, aes(x = x, y = center_y, linetype = model, color = model) ) +
                geom_smooth(span = 0.5, se = FALSE) + # choose span? 
                scale_color_manual(values = c("blue","red", "orange")) +
                labs(y = "Fitted function",
                     x = x_var) +
                theme_bw(base_size = 12) +
                theme(plot.margin = unit(c(0.05, 0.2, 0.05, 0.5), "cm")) +
                theme(axis.text.x = element_text(size = 12, color = "black"),
                      axis.text.y = element_text(size = 12, color = "black"),
                      axis.title.x = element_text(size=16),
                      axis.title.y = element_text(size=16),
                      panel.border = element_rect(color = "black", size = 1.25),
                      panel.grid.major = element_line(color = 'white', linetype = 'dashed'), panel.grid.minor = element_blank(),
                      legend.position = "none") +
                scale_x_continuous(labels = scales::format_format(scientific = FALSE)) +
                #scale_x_continuous(labels = comma) +
                #ylim(-1.55, 1.55) +
                geom_hline(yintercept=0)+
                scale_y_continuous(limits=c(-2.0,2.0), breaks=c(-2,-1,0,1,2))
}

pardep_plot_mods3(data = pred_mods3[[1]], x_var = x_names3[[1]])
```




# Loop through the models and the x variable names
    simultaneously with map2()
```{r}
all_mod_plots3 = map2(pred_mods3, x_names3, pardep_plot_mods3)
all_mod_plots3
```






## Legend 


```{r}
legend4 <- get_legend(legend.plot4) 
```



## Figure for Poster

```{r fig.height=7, fig.width=15}
grid_all4 = cowplot::plot_grid(all_mod_plots4$ndviprefire, all_mod_plots4$fwi, all_mod_plots4$elevation, all_mod_plots4$dndmi,  all_mod_plots3$ndviprefire, all_mod_plots3$fwi, all_mod_plots3$elevation,  legend4, nrow = 2) + 
   draw_label("dead/\nsparse", x = .1, y = .62, size = 16) +
   draw_label("live/\ndense", x = .2, y = .62, size = 16) +
   draw_label("dead/\nsparse", x = .1, y = .12, size = 16) +
   draw_label("live/\ndense", x = .2, y = .12, size = 16) +
   draw_label("moderate", x = .35, y = .61, size = 16) +
   draw_label("extreme", x = .45, y = .61, size = 16) +
   draw_label("moderate", x = .35, y = .11, size = 16) +
   draw_label("extreme", x = .45, y = .11, size = 16) +
   draw_label("low", x = .57, y = .61, size = 16) +
   draw_label("high", x = .7, y = .61, size = 16) +
   draw_label("low", x = .57, y = .11, size = 16) +
   draw_label("high", x = .7, y = .11, size = 16) +
   draw_label("no\nmortality", x = .83, y = .62, size = 16) +
   draw_label("high\nmortality", x = .96, y = .62, size = 16) +
   draw_label("(a)", x = .06, y = .98, size = 14) +
   draw_label("(b)", x = .31, y = .98, size = 14) +
   draw_label("(c)", x = .56, y = .98, size = 14) +
   draw_label("(d)", x = .81, y = .98, size = 14) +
   draw_label("(e)", x = .06, y = .48, size = 14) +
   draw_label("(f)", x = .31, y = .48, size = 14) +
   draw_label("(g)", x = .56, y = .48, size = 14) 
grid_all4
```


```{r}
row1 = ggdraw() + draw_label('Outbreak severity\nincluded', size = 20, fontface = 'bold', angle = 90) 
row2 = ggdraw() + draw_label('Outbreak severity\nexcluded', size = 20, fontface = 'bold', angle = 90) 
header2 = cowplot::plot_grid(row1, row2, nrow=2)
header2
```

### Full figure with legend on Right
```{r fig.height=7, fig.width=15}
( grid_final4 = cowplot::plot_grid(header2, grid_all4, nrow=1, rel_widths = c(0.04, 1))  )
```

```{r eval=FALSE, include=FALSE}
ggsave("../figures/2019-12-03_partialplots_legendright_poster.tiff", plot = grid_final4, width = 15, height = 7, units = c("in"), dpi=600 )
```

**THE END**